<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>128-bit Password Generator üîê</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#6ee7b7;
      --muted:#9aa7bc; --danger:#ff7b7b; --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#071022 0%, #081028 60%), radial-gradient(800px 400px at 10% 10%, rgba(110,231,183,0.03), transparent 10%);
      color:#e6eef8;
      padding:24px;
    }
    .card{
      width:100%; max-width:920px; background:linear-gradient(180deg,var(--card), #071025);
      border-radius:12px; padding:22px; box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    h1{margin:0 0 6px 0; font-size:20px}
    p.lead{margin:0 0 18px 0; color:var(--muted); font-size:13px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .controls{flex:1; min-width:260px}
    .control{
      display:flex; align-items:center; gap:8px; margin-bottom:10px;
    }
    .control label{min-width:160px; color:var(--muted); font-size:13px}
    .checkboxes{display:flex; gap:8px; flex-wrap:wrap}
    .checkbox{display:flex; align-items:center; gap:8px; background:var(--glass); padding:8px 10px; border-radius:8px; font-size:13px; color:var(--muted)}
    input[type="number"]{width:88px; padding:8px 10px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:inherit; border-radius:8px}
    .btn{
      display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border-radius:10px;
      background:linear-gradient(90deg,var(--accent), #3ee0d3); color:#052023; border:none; cursor:pointer; font-weight:700;
      box-shadow: 0 6px 18px rgba(51,214,183,0.12);
    }
    .btn.outline{background:transparent; color:var(--accent); border:1px solid rgba(110,231,183,0.12); box-shadow:none}
    .output{
      margin-top:18px; display:flex; gap:8px; align-items:center;
      background:rgba(255,255,255,0.02); padding:14px; border-radius:10px; width:100%;
    }
    .password{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
      font-size:14px; word-break:break-all; color:#e6fff8; flex:1;
    }
    .meta{margin-top:12px; color:var(--muted); font-size:13px; display:flex; gap:18px; flex-wrap:wrap;}
    .meter{
      height:10px; background:rgba(255,255,255,0.04); border-radius:10px; overflow:hidden; width:220px;
    }
    .meter > i{display:block; height:100%; background:linear-gradient(90deg,#ffb86b,#6ee7b7); width:0%;}
    .small{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; align-items:center}
    .copy-btn{padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.02); color:var(--muted); border:1px solid rgba(255,255,255,0.02); cursor:pointer}
    .footer{margin-top:18px; color:var(--muted); font-size:12px}
    .mode-toggle{display:inline-flex; gap:6px; background:rgba(255,255,255,0.02); padding:6px; border-radius:8px}
    .mode-toggle button{background:transparent; border:0; color:var(--muted); padding:6px 10px; border-radius:6px; cursor:pointer}
    .mode-toggle button.active{background:linear-gradient(90deg,var(--accent), #3ee0d3); color:#052023; font-weight:700}
    footer.attribution{color:var(--muted); font-size:12px; margin-top:12px}
    @media (max-width:720px){
      .row{flex-direction:column}
      .control label{min-width:120px}
    }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">128-bit Password Generator üîê</h1>
    <p class="lead">Generates cryptographically secure passwords using <code>crypto.getRandomValues</code>. Default creates a password with <strong>128 bits of entropy</strong> using the selected character sets.</p>

    <div class="row">
      <div class="controls" aria-label="controls">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="mode-toggle" role="tablist" aria-label="mode">
            <button id="modeEntropy" class="active" role="tab" aria-selected="true">128-bit entropy</button>
            <button id="modeLength" role="tab" aria-selected="false">128-char</button>
          </div>
          <div class="small">üîí Secure RNG: <strong>crypto.getRandomValues</strong></div>
        </div>

        <div class="control">
          <label for="lengthInput">Password length</label>
          <input id="lengthInput" type="number" min="1" value="16" aria-label="password length">
          <div class="small" style="margin-left:auto">auto-calculated for entropy mode</div>
        </div>

        <div class="control">
          <label>Character sets</label>
          <div class="checkboxes" role="group" aria-label="character sets">
            <label class="checkbox"><input id="chkLower" type="checkbox" checked> abc</label>
            <label class="checkbox"><input id="chkUpper" type="checkbox" checked> ABC</label>
            <label class="checkbox"><input id="chkDigits" type="checkbox" checked> 0-9</label>
            <label class="checkbox"><input id="chkSpecial" type="checkbox" checked> !@#$‚Ä¶</label>
            <label class="checkbox"><input id="chkAmbig" type="checkbox"> hide ambiguous</label>
          </div>
        </div>

        <div class="control">
          <label>Generate</label>
          <div style="display:flex; gap:8px;">
            <button id="genBtn" class="btn">Generate</button>
            <button id="gen128Bits" class="btn outline" title="Generate password targeting 128 bits of entropy">128-bit</button>
            <button id="gen128Chars" class="btn outline" title="Generate a 128-character password">128-char</button>
          </div>
        </div>

        <div class="output" aria-live="polite">
          <div class="password" id="password" tabindex="0" aria-label="generated password">‚Äî</div>
          <div class="actions">
            <button class="copy-btn" id="copyBtn">Copy</button>
            <button class="copy-btn" id="regenBtn" title="Regenerate">Regenerate</button>
          </div>
        </div>

        <div class="meta" aria-hidden="false">
          <div class="small">Charset size: <strong id="charsetSize">0</strong></div>
          <div class="small">Entropy/char: <strong id="entropyPerChar">0</strong> bits</div>
          <div class="small">Target entropy: <strong id="targetEntropy">128</strong> bits</div>
          <div class="small">Calculated length: <strong id="calculatedLength">0</strong> chars</div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-top:10px">
          <div class="meter" aria-hidden="true"><i id="meterFill"></i></div>
          <div class="small" id="strengthLabel">Strength: ‚Äî</div>
        </div>

        <div class="footer">
          <div>Tip: you can tweak sets and press <strong>Generate</strong> or use the quick buttons.</div>
          <div class="attribution">Made with üî®ü§ñüîß ‚Äî uses unbiased sampling for secure randomness</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Character sets ---
    const SETS = {
      lower: "abcdefghijklmnopqrstuvwxyz",
      upper: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
      digits: "0123456789",
      // Safe set of special characters commonly accepted by password fields:
      special: "!@#$%^&*()-_=+[]{};:,.<>/?~"
    };

    // Ambiguous characters commonly hidden: "Il1O0" etc.
    const AMBIGUOUS = "Il1O0`'\"|\\/,.;:[]{}()<>";

    // Helper: unbiased random integer in [0, max-1] using crypto.getRandomValues with rejection sampling
    function secureRandomInt(max){
      if (!Number.isInteger(max) || max <= 0) throw new Error("max must be positive integer");
      const limit = Math.floor(0x100000000 / max) * max; // 2^32
      const arr = new Uint32Array(1);
      let r;
      do {
        window.crypto.getRandomValues(arr);
        r = arr[0];
      } while (r >= limit);
      return r % max;
    }

    // Build charset based on checkboxes
    function buildCharset(options){
      let cs = "";
      if (options.lower) cs += SETS.lower;
      if (options.upper) cs += SETS.upper;
      if (options.digits) cs += SETS.digits;
      if (options.special) cs += SETS.special;
      if (options.ambig === false){ // if "hide ambiguous" is checked, remove ambiguous chars
        cs = cs.split('').filter(ch => !AMBIGUOUS.includes(ch)).join('');
      }
      // Remove duplicates just in case (not really necessary here)
      cs = Array.from(new Set(cs.split(''))).join('');
      return cs;
    }

    // Generate a password with given length from charset using secureRandomInt (unbiased)
    function generatePassword(length, charset){
      if (charset.length === 0) return "";
      let out = "";
      for (let i = 0; i < length; i++){
        const idx = secureRandomInt(charset.length);
        out += charset[idx];
      }
      return out;
    }

    // UI elements
    const chkLower = document.getElementById('chkLower');
    const chkUpper = document.getElementById('chkUpper');
    const chkDigits = document.getElementById('chkDigits');
    const chkSpecial = document.getElementById('chkSpecial');
    const chkAmbig = document.getElementById('chkAmbig');

    const lengthInput = document.getElementById('lengthInput');
    const passwordDiv = document.getElementById('password');
    const genBtn = document.getElementById('genBtn');
    const gen128Bits = document.getElementById('gen128Bits');
    const gen128Chars = document.getElementById('gen128Chars');
    const copyBtn = document.getElementById('copyBtn');
    const regenBtn = document.getElementById('regenBtn');

    const charsetSizeEl = document.getElementById('charsetSize');
    const entropyPerCharEl = document.getElementById('entropyPerChar');
    const targetEntropyEl = document.getElementById('targetEntropy');
    const calculatedLengthEl = document.getElementById('calculatedLength');

    const meterFill = document.getElementById('meterFill');
    const strengthLabel = document.getElementById('strengthLabel');

    const modeEntropyBtn = document.getElementById('modeEntropy');
    const modeLengthBtn = document.getElementById('modeLength');

    let lastSettings = null; // keep last used settings for quick regen

    function getOptionsFromUI(){
      return {
        lower: chkLower.checked,
        upper: chkUpper.checked,
        digits: chkDigits.checked,
        special: chkSpecial.checked,
        ambig: chkAmbig.checked  // if true, "hide ambiguous" is ON; we'll remove ambiguous characters
      };
    }

    // Calculate entropy per char: log2(charsetSize)
    function bitsPerChar(charsetSize){
      if (charsetSize <= 0) return 0;
      return Math.log2(charsetSize);
    }

    // Calculate minimal length to reach target entropy
    function lengthForEntropy(targetBits, bpChar){
      if (bpChar <= 0) return Infinity;
      return Math.ceil(targetBits / bpChar);
    }

    // Update UI metadata and auto length if in entropy mode
    let mode = 'entropy'; // 'entropy' or 'length'
    function updateMeta(){
      const opts = getOptionsFromUI();
      // Note: opts.ambig === true means "hide ambiguous" is checked; buildCharset expects ambig false? adapt:
      const built = buildCharset({
        lower: opts.lower,
        upper: opts.upper,
        digits: opts.digits,
        special: opts.special,
        ambig: !opts.ambig // buildCharset expects ambig=false to remove ambiguous chars
      });
      const csSize = built.length;
      const bp = bitsPerChar(csSize);
      const target = 128;
      const required = lengthForEntropy(target, bp);

      charsetSizeEl.textContent = csSize;
      entropyPerCharEl.textContent = bp ? bp.toFixed(3) : "0";
      targetEntropyEl.textContent = target;
      calculatedLengthEl.textContent = isFinite(required) ? required : "N/A";

      // update length input only if in entropy mode (auto)
      if (mode === 'entropy'){
        if (isFinite(required)) lengthInput.value = required;
      }

      // update strength meter: compute entropy for current length
      const curLen = Number(lengthInput.value) || 0;
      const totalEntropy = bp * curLen;
      const pct = Math.min(100, Math.round((totalEntropy / 256) * 100)); // visualize against 256 bits (arbitrary)
      meterFill.style.width = pct + "%";

      let label = `${Math.round(totalEntropy)} bits`;
      if (totalEntropy < 64) label = "Weak ‚Äî " + label;
      else if (totalEntropy < 96) label = "Medium ‚Äî " + label;
      else if (totalEntropy < 128) label = "Strong ‚Äî " + label;
      else label = "Very strong ‚Äî " + label;
      strengthLabel.textContent = "Strength: " + label;
    }

    // Generate with current UI settings
    function doGenerate(useTargetEntropy=false, forceLength=null){
      const opts = getOptionsFromUI();
      const charset = buildCharset({
        lower: opts.lower,
        upper: opts.upper,
        digits: opts.digits,
        special: opts.special,
        ambig: !opts.ambig
      });
      if (charset.length === 0){
        passwordDiv.textContent = "Please select at least one character set.";
        return;
      }

      let length = Number(lengthInput.value) || 0;
      if (useTargetEntropy){
        // compute minimal length to reach 128 bits
        const bp = bitsPerChar(charset.length);
        if (bp <= 0){
          passwordDiv.textContent = "Charset problem ‚Äî cannot compute entropy.";
          return;
        }
        length = lengthForEntropy(128, bp);
      }
      if (forceLength !== null) length = forceLength;

      // keep settings for quick regen
      lastSettings = {charset, length};

      // generate
      const pwd = generatePassword(length, charset);
      passwordDiv.textContent = pwd;
      passwordDiv.setAttribute('aria-label', 'generated password: ' + pwd);

      // update display metas
      updateMeta();
    }

    // Hook events
    genBtn.addEventListener('click', () => doGenerate(false));
    gen128Bits.addEventListener('click', () => { mode='entropy'; setModeButtons(); doGenerate(true); });
    gen128Chars.addEventListener('click', () => { mode='length'; setModeButtons(); doGenerate(false, 128); });

    copyBtn.addEventListener('click', async () => {
      const text = passwordDiv.textContent || "";
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = "Copied ‚úÖ";
        setTimeout(()=> copyBtn.textContent = "Copy", 1500);
      } catch(e){
        // fallback
        try {
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta); ta.select();
          document.execCommand('copy'); document.body.removeChild(ta);
          copyBtn.textContent = "Copied ‚úÖ";
          setTimeout(()=> copyBtn.textContent = "Copy", 1500);
        } catch(err){
          copyBtn.textContent = "Copy failed";
          setTimeout(()=> copyBtn.textContent = "Copy", 1500);
        }
      }
    });

    regenBtn.addEventListener('click', () => {
      if (lastSettings){
        const {charset, length} = lastSettings;
        const p = generatePassword(length, charset);
        passwordDiv.textContent = p;
      } else {
        doGenerate(mode === 'entropy');
      }
    });

    // When char set toggles or length changes, update metadata
    [chkLower, chkUpper, chkDigits, chkSpecial, chkAmbig].forEach(el => el.addEventListener('change', updateMeta));
    lengthInput.addEventListener('input', () => { mode = 'length'; setModeButtons(); updateMeta(); });

    // Mode toggle UI
    function setModeButtons(){
      if (mode === 'entropy'){
        modeEntropyBtn.classList.add('active'); modeEntropyBtn.setAttribute('aria-selected','true');
        modeLengthBtn.classList.remove('active'); modeLengthBtn.setAttribute('aria-selected','false');
      } else {
        modeLengthBtn.classList.add('active'); modeLengthBtn.setAttribute('aria-selected','true');
        modeEntropyBtn.classList.remove('active'); modeEntropyBtn.setAttribute('aria-selected','false');
      }
    }
    modeEntropyBtn.addEventListener('click', () => { mode='entropy'; setModeButtons(); updateMeta(); });
    modeLengthBtn.addEventListener('click', () => { mode='length'; setModeButtons(); updateMeta(); });

    // Initialize
    updateMeta();

    // Autofill a first password for convenience (128 bits)
    doGenerate(true);

    // Accessibility: allow clicking password box to select all and focus
    passwordDiv.addEventListener('click', () => {
      const range = document.createRange();
      range.selectNodeContents(passwordDiv);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    });

    // For very small viewports, ensure button labels don't overflow
    window.addEventListener('resize', ()=>{/* no-op; could adapt UI further */});
  </script>
</body>
</html>