<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Code Vault + Meshtastic Sender</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b1020; --panel:#121931; --muted:#7f8bb3; --text:#e7ecff; --accent:#7c9cff; --accent2:#3ed0a1; --danger:#ff6b6b;
      --border:rgba(255,255,255,.12); --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background:linear-gradient(160deg, #0b1020, #0f1430 50%, #111a34);
      color:var(--text); display:flex; align-items:center; justify-content:center; padding:32px;
    }
    .app{width:min(980px,100%); display:grid; gap:16px}
    .card{
      background:rgba(10,14,30,.6); backdrop-filter: blur(8px);
      border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:18px
    }
    h1,h2{margin:0 0 10px}
    h1{font-size:1.4rem; display:flex; align-items:center; gap:.6rem}
    h2{font-size:1.05rem; color:var(--muted)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .full{grid-column:1 / -1}
    label{display:block; font-size:.9rem; color:var(--muted); margin:10px 0 6px}
    input, textarea, select{
      width:100%; padding:12px 14px; border-radius:12px; outline:none;
      background:#0f1530; border:1px solid var(--border); color:var(--text);
      font-size:.98rem; transition:border-color .2s;
    }
    textarea{min-height:120px; resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:var(--accent)}
    .btn{
      appearance:none; border:none; padding:12px 16px; border-radius:12px; cursor:pointer;
      color:#0b1020; background:var(--accent); font-weight:700; box-shadow:0 6px 18px rgba(124,156,255,.25);
    }
    .btn.secondary{background:var(--accent2); color:#04101a}
    .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--border)}
    .btn.danger{background:var(--danger); color:white}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .stack{display:flex; gap:10px; flex-wrap:wrap}
    .notice{font-size:.9rem; color:var(--muted)}
    .ok{color:var(--accent2)} .bad{color:var(--danger)}
    .hidden{display:none !important}
    .tabs{display:flex; gap:8px; margin-top:8px}
    .tab-btn{padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0e1532; color:var(--muted); cursor:pointer}
    .tab-btn.active{background:#1a2247; color:var(--text); border-color:#2a3772}
    code.k{user-select:all; word-break:break-all}
    .header{display:flex; justify-content:space-between; align-items:center}
    .footer{opacity:.7; text-align:center; font-size:.85rem}
    .chip{display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:.85rem}
  </style>
</head>
<body>
  <main class="app">

    <!-- LOGIN / SETUP -->
    <section id="loginCard" class="card">
      <div class="header">
        <h1>üîê Secure Vault & Meshtastic Sender</h1>
        <span class="chip">Client‚Äëside ‚Ä¢ AES‚Äë256‚ÄëGCM</span>
      </div>
      <p class="notice">
        First time here? Set a password, we‚Äôll store ONLY a salted verifier in <code>localStorage</code>.
        Returning? Enter your password to unlock.
      </p>

      <div id="setupBlock">
        <div class="row">
          <div>
            <label for="newPassword">New password</label>
            <input id="newPassword" type="password" autocomplete="new-password" placeholder="Create a strong password" />
          </div>
          <div>
            <label for="newPassword2">Confirm password</label>
            <input id="newPassword2" type="password" autocomplete="new-password" placeholder="Repeat password" />
          </div>
        </div>
        <div class="stack">
          <button id="createVaultBtn" class="btn">Create Vault</button>
          <span id="setupMsg" class="notice"></span>
        </div>
        <hr class="full" style="opacity:.15;margin:16px 0">
      </div>

      <div id="signinBlock" class="row">
        <div class="full">
          <label for="password">Unlock with password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="Enter your password" />
        </div>
        <div class="stack full">
          <button id="unlockBtn" class="btn">Unlock</button>
          <button id="resetVaultBtn" class="btn danger">Forget Vault</button>
          <span id="loginMsg" class="notice"></span>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="appCard" class="card hidden">
      <div class="header">
        <h1>üîì Vault Unlocked</h1>
        <div class="stack">
          <span id="keyInfo" class="chip">Key: not ready</span>
          <button id="lockBtn" class="btn ghost">Lock</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="codesTab">‚ûø Code Vault</button>
        <button class="tab-btn" data-tab="meshtasticTab">üì° Meshtastic Sender</button>
        <button class="tab-btn" data-tab="settingsTab">‚öôÔ∏è Settings</button>
      </div>

      <!-- CODE VAULT -->
      <div id="codesTab" class="tab card" style="margin-top:10px;">
        <h2>‚ûø Create or Recover a Code (AES‚Äë256‚ÄëGCM)</h2>
        <div class="row">
          <div class="full">
            <label for="plainCode">Your secret ‚Äúcode‚Äù (plain text)</label>
            <textarea id="plainCode" placeholder="Type the code you want to protect..."></textarea>
          </div>
          <div>
            <button id="encryptBtn" class="btn">Encrypt ‚Üí</button>
          </div>
        </div>

        <div class="row">
          <div class="full">
            <label for="cipherOut">Ciphertext to write down (save this)</label>
            <textarea id="cipherOut" readonly placeholder="Encrypted result will appear here"></textarea>
            <div class="stack" style="margin-top:8px">
              <button id="copyCipherBtn" class="btn ghost">Copy Ciphertext</button>
              <span class="notice">IV + salt + ciphertext are bundled and Base64‚Äëencoded.</span>
            </div>
          </div>
        </div>

        <hr class="full" style="opacity:.15;margin:16px 0">

        <div class="row">
          <div class="full">
            <label for="cipherIn">Paste ciphertext to decrypt</label>
            <textarea id="cipherIn" placeholder="Paste the saved ciphertext here..."></textarea>
          </div>
          <div>
            <button id="decryptBtn" class="btn secondary">‚Üê Decrypt</button>
          </div>
        </div>

        <div class="row">
          <div class="full">
            <label>Decrypted output</label>
            <pre id="plainOut" class="card" style="white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas; padding:12px; background:#0d1430; border-radius:12px; min-height:48px;"></pre>
          </div>
        </div>
      </div>

      <!-- MESHTASTIC -->
      <div id="meshtasticTab" class="tab card hidden" style="margin-top:10px;">
        <h2>üì° Send a Meshtastic Message (MQTT over WebSockets)</h2>
        <p class="notice">
          Enter your MQTT‚Äëover‚ÄëWebSocket broker details (e.g. a Meshtastic relay/broker you control).
          Credentials are optionally stored <em>encrypted in your vault</em>.
        </p>
        <div class="row">
          <div>
            <label for="mqttUrl">Broker (WebSocket)</label>
            <input id="mqttUrl" placeholder="wss://your-broker:port/mqtt" />
          </div>
          <div>
            <label for="mqttClientId">Client ID</label>
            <input id="mqttClientId" placeholder="webclient-1234" />
          </div>
          <div>
            <label for="mqttUser">Username</label>
            <input id="mqttUser" placeholder="(optional)" />
          </div>
          <div>
            <label for="mqttPass">Password / Token</label>
            <input id="mqttPass" type="password" placeholder="(optional)" />
          </div>

          <div class="full">
            <label for="mqttTopic">Topic</label>
            <input id="mqttTopic" placeholder="e.g. msh/XXXXX/c/send or your relay topic" />
          </div>
          <div class="full">
            <label for="mqttPayload">Message</label>
            <textarea id="mqttPayload" placeholder="Hello, mesh!"></textarea>
          </div>
        </div>

        <div class="stack">
          <button id="mqttConnectBtn" class="btn">Connect</button>
          <button id="mqttSendBtn" class="btn secondary" disabled>Send</button>
          <button id="saveMqttBtn" class="btn ghost">Save Encrypted Settings</button>
          <button id="clearMqttBtn" class="btn danger">Clear Saved</button>
          <span id="mqttStatus" class="notice">Disconnected</span>
        </div>

        <p class="notice" style="margin-top:8px">
          Tip üí°: Many brokers expose WebSocket at <code>wss://broker:port/mqtt</code>. Ensure CORS/TLS is configured.
        </p>
      </div>

      <!-- SETTINGS -->
      <div id="settingsTab" class="tab card hidden" style="margin-top:10px;">
        <h2>‚öôÔ∏è Vault Settings</h2>
        <div class="row">
          <div>
            <label>PBKDF2 Iterations</label>
            <input id="iterInput" type="number" min="60000" step="1000" />
          </div>
          <div>
            <label>Salt (Base64)</label>
            <input id="saltInput" />
          </div>
        </div>
        <div class="stack" style="margin-top:8px">
          <button id="regenSaltBtn" class="btn">Regenerate Salt</button>
          <button id="saveSettingsBtn" class="btn secondary">Save</button>
          <span id="settingsMsg" class="notice"></span>
        </div>
        <p class="notice">Changing salt/iterations invalidates current verifier; you‚Äôll need to re‚Äëset the password.</p>
      </div>

      <div class="footer notice">
        Built with Web Crypto API ‚Ä¢ AES‚Äë256‚ÄëGCM ‚Ä¢ PBKDF2‚ÄëSHA‚Äë256 ‚Ä¢ MQTT over WebSockets (Paho)
      </div>
    </section>
  </main>

  <!-- MQTT over WebSockets (Paho) -->
  <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt-min.js"></script>

  <script>
  // ========================= Utils =========================
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];
  const utf8 = new TextEncoder();
  const utf8d = new TextDecoder();
  const b64 = {
    enc: bytes => btoa(String.fromCharCode(...bytes)),
    dec: str => new Uint8Array(atob(str).split('').map(c => c.charCodeAt(0)))
  };
  const concat = (...arrs) => {
    const len = arrs.reduce((a,b)=>a+b.length,0);
    const out = new Uint8Array(len);
    let o=0; for(const a of arrs){ out.set(a,o); o+=a.length; }
    return out;
  };
  const timingSafeEq = (a,b) => {
    if(a.length !== b.length) return false;
    let diff = 0; for(let i=0;i<a.length;i++){ diff |= a[i]^b[i]; }
    return diff === 0;
  };
  const randBytes = n => crypto.getRandomValues(new Uint8Array(n));

  // ========================= Vault persistence =========================
  const VAULT_KEY = "vault.config.v1";
  const DEFAULTS = {
    kdf: { iter: 150_000, salt: b64.enc(randBytes(16)) }, // 128-bit salt
    verifier: null, // base64 PBKDF2-derived 32 bytes
    // encrypted MQTT settings (optional)
    mqtt: null
  };
  function loadConf(){
    try{ return Object.assign({}, DEFAULTS, JSON.parse(localStorage.getItem(VAULT_KEY)||"{}")); }
    catch{ return {...DEFAULTS}; }
  }
  function saveConf(conf){ localStorage.setItem(VAULT_KEY, JSON.stringify(conf)); }

  let CONF = loadConf();
  let session = { key: null, unlocked: false, material: null, iter: CONF.kdf.iter, saltB: b64.dec(CONF.kdf.salt) };

  // ========================= WebCrypto: KDF & AES =========================
  async function deriveKeyMaterial(password, salt, iter){
    const baseKey = await crypto.subtle.importKey(
      "raw", utf8.encode(password), "PBKDF2", false, ["deriveBits","deriveKey"]
    );
    const params = { name: "PBKDF2", hash: "SHA-256", salt, iterations: iter };
    // We derive 32 bytes for verifier and also an AES-GCM key
    const bits = await crypto.subtle.deriveBits(params, baseKey, 256);
    const derived = new Uint8Array(bits); // 32 bytes
    const aesKey = await crypto.subtle.deriveKey(params, baseKey, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]);
    return { derived, aesKey };
  }

  async function encryptWithKey(aesKey, plain){
    const iv = randBytes(12); // GCM 96-bit IV recommended
    const ct = new Uint8Array(await crypto.subtle.encrypt({name:"AES-GCM", iv}, aesKey, utf8.encode(plain)));
    // Pack: [magic:2]["1":1][iv:12][salt:16][ct:n]
    const magic = new Uint8Array([0xA5,0xEC]); // simple version marker
    const ver = new Uint8Array([0x01]);
    const payload = concat(magic, ver, iv, b64.dec(CONF.kdf.salt), ct);
    return b64.enc(payload);
  }
  async function decryptWithKey(aesKey, b64blob){
    const all = b64.dec(b64blob.trim());
    if(all.length < 2+1+12+16+1) throw new Error("Ciphertext too short");
    const magic = all.slice(0,2); const ver = all[2];
    if(magic[0]!==0xA5 || magic[1]!==0xEC) throw new Error("Bad magic");
    if(ver!==0x01) throw new Error("Unsupported version");
    const iv = all.slice(3, 15);
    const salt = all.slice(15, 31);
    // Safety: ensure salt matches current (enforces same vault KDF context)
    if(!timingSafeEq(salt, b64.dec(CONF.kdf.salt))) throw new Error("Ciphertext salt mismatch with this vault");
    const ct = all.slice(31);
    const pt = await crypto.subtle.decrypt({name:"AES-GCM", iv}, aesKey, ct);
    return utf8d.decode(pt);
  }

  // ========================= UI: Tabs & State =========================
  function show(el, yes=true){ el.classList.toggle("hidden", !yes); }
  function setTab(tabId){
    $$(".tab-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tabId));
    $$(".tab").forEach(t=>show(t, t.id===tabId));
  }
  $$(".tab-btn").forEach(b=>b.addEventListener("click", ()=>setTab(b.dataset.tab)));

  function refreshSettingsUI(){
    $("#iterInput").value = CONF.kdf.iter;
    $("#saltInput").value = CONF.kdf.salt;
  }
  refreshSettingsUI();

  function updateKeyInfo(){
    $("#keyInfo").textContent = session.unlocked ? "Key: ready (AES‚Äë256‚ÄëGCM)" : "Key: locked";
  }

  // ========================= Setup / Create Vault =========================
  $("#createVaultBtn").addEventListener("click", async ()=>{
    const p1 = $("#newPassword").value, p2 = $("#newPassword2").value;
    const msg = $("#setupMsg");
    msg.textContent = "";
    if(!p1 || p1.length<10) { msg.textContent="Use at least 10 characters."; return; }
    if(p1 !== p2) { msg.textContent="Passwords do not match."; return; }
    try{
      const salt = randBytes(16);
      const iter = Math.max(60_000, CONF.kdf.iter|0);
      const { derived, aesKey } = await deriveKeyMaterial(p1, salt, iter);
      CONF.kdf = { iter, salt: b64.enc(salt) };
      CONF.verifier = b64.enc(derived);
      saveConf(CONF);
      session = { key: aesKey, unlocked: true, material: derived, iter, saltB: salt };
      $("#loginMsg").textContent = "";
      $("#setupMsg").textContent = "Vault created ‚úîÔ∏è";
      show($("#loginCard"), false);
      show($("#appCard"), true);
      updateKeyInfo();
    }catch(err){
      msg.textContent = "Error creating vault: " + err.message;
    }
  });

  // ========================= Unlock Existing =========================
  $("#unlockBtn").addEventListener("click", async ()=>{
    const p = $("#password").value;
    const msg = $("#loginMsg");
    msg.textContent="";
    if(!CONF.verifier){ msg.textContent="No vault yet. Create one above."; return; }
    try{
      const salt = b64.dec(CONF.kdf.salt);
      const { derived, aesKey } = await deriveKeyMaterial(p, salt, CONF.kdf.iter);
      const ok = timingSafeEq(derived, b64.dec(CONF.verifier));
      if(!ok){ msg.textContent = "Invalid password."; return; }
      session = { key: aesKey, unlocked: true, material: derived, iter: CONF.kdf.iter, saltB: salt };
      show($("#loginCard"), false);
      show($("#appCard"), true);
      updateKeyInfo();
      if(CONF.mqtt){ // lazily decrypt saved mqtt settings
        try{ await loadEncryptedMqttSettings(); }catch{}
      }
    }catch(err){
      msg.textContent = "Unlock failed: " + err.message;
    }
  });

  $("#lockBtn").addEventListener("click", ()=>{
    session = { key:null, unlocked:false, material:null, iter:CONF.kdf.iter, saltB:b64.dec(CONF.kdf.salt) };
    show($("#appCard"), false);
    show($("#loginCard"), true);
    updateKeyInfo();
  });

  $("#resetVaultBtn").addEventListener("click", ()=>{
    if(!confirm("This will delete your verifier and saved settings from this browser.")) return;
    localStorage.removeItem(VAULT_KEY);
    CONF = loadConf();
    session = { key:null, unlocked:false, material:null, iter:CONF.kdf.iter, saltB:b64.dec(CONF.kdf.salt) };
    $("#loginMsg").textContent = "Vault reset. Create a new password.";
    refreshSettingsUI(); updateKeyInfo();
  });

  // ========================= Settings =========================
  $("#regenSaltBtn").addEventListener("click", ()=>{
    $("#saltInput").value = b64.enc(randBytes(16));
  });
  $("#saveSettingsBtn").addEventListener("click", ()=>{
    const it = Math.max(60_000, parseInt($("#iterInput").value||"150000",10));
    const saltStr = $("#saltInput").value.trim();
    try{
      // validate base64
      const test = b64.dec(saltStr);
      if(test.length !== 16) throw new Error("Salt must be 16 bytes (128‚Äëbit)");
      CONF.kdf.iter = it; CONF.kdf.salt = saltStr; CONF.verifier = null; // must re‚Äëset password
      saveConf(CONF);
      $("#settingsMsg").textContent = "Saved. Re‚Äëcreate your password to continue.";
      $("#signinBlock").scrollIntoView({behavior:"smooth"});
    }catch(e){
      $("#settingsMsg").textContent = "Invalid salt: " + e.message;
    }
  });

  // ========================= Code Vault (Encrypt/Decrypt) =========================
  $("#encryptBtn").addEventListener("click", async ()=>{
    if(!session.unlocked) return alert("Lock status invalid. Re‚Äëunlock.");
    const txt = $("#plainCode").value;
    if(!txt){ alert("Enter something to encrypt."); return; }
    try{
      const out = await encryptWithKey(session.key, txt);
      $("#cipherOut").value = out;
    }catch(e){ alert("Encrypt error: " + e.message); }
  });

  $("#copyCipherBtn").addEventListener("click", ()=>{
    if(!$("#cipherOut").value) return;
    navigator.clipboard.writeText($("#cipherOut").value).then(()=> {
      $("#copyCipherBtn").textContent = "Copied ‚úîÔ∏è";
      setTimeout(()=>$("#copyCipherBtn").textContent="Copy Ciphertext", 1200);
    });
  });

  $("#decryptBtn").addEventListener("click", async ()=>{
    if(!session.unlocked) return alert("Lock status invalid. Re‚Äëunlock.");
    const blob = $("#cipherIn").value;
    if(!blob){ alert("Paste ciphertext."); return; }
    try{
      const pt = await decryptWithKey(session.key, blob);
      $("#plainOut").textContent = pt;
    }catch(e){ $("#plainOut").textContent = "‚ùå " + e.message; }
  });

  // ========================= MQTT (Meshtastic) =========================
  let mqttClient = null;

  function setMqttStatus(txt, good=false){
    $("#mqttStatus").textContent = txt;
    $("#mqttStatus").className = "notice " + (good ? "ok":"");
  }

  function getMqttFields(){
    return {
      url: $("#mqttUrl").value.trim(),
      clientId: ($("#mqttClientId").value.trim() || ("webclient-"+Math.random().toString(16).slice(2))),
      user: $("#mqttUser").value,
      pass: $("#mqttPass").value,
      topic: $("#mqttTopic").value.trim(),
      payload: $("#mqttPayload").value
    };
  }

  $("#mqttConnectBtn").addEventListener("click", ()=>{
    const { url, clientId, user, pass } = getMqttFields();
    if(!url){ alert("Broker URL required (wss://...)"); return; }
    try{
      if(mqttClient && mqttClient.isConnected()) { mqttClient.disconnect(); }
      // Parse URL to host/port/path for Paho
      const a = document.createElement("a"); a.href = url;
      const useTLS = a.protocol === "wss:";
      const host = a.hostname; const port = a.port ? parseInt(a.port,10) : (useTLS?443:80);
      const path = a.pathname + (a.search||"");
      mqttClient = new Paho.MQTT.Client(host, port, path, clientId);
      mqttClient.onConnectionLost = (resp)=> setMqttStatus("Disconnected: " + (resp.errorMessage||""));
      mqttClient.onMessageArrived = (m)=> console.log("incoming", m.topic, m.payloadString);
      mqttClient.connect({
        useSSL: useTLS,
        userName: user || undefined,
        password: pass || undefined,
        timeout: 6,
        onSuccess: ()=>{ setMqttStatus("Connected ‚úîÔ∏è", true); $("#mqttSendBtn").disabled=false; },
        onFailure: (e)=> setMqttStatus("Connect failed: "+(e.errorMessage||""))
      });
    }catch(e){ setMqttStatus("Error: "+e.message); }
  });

  $("#mqttSendBtn").addEventListener("click", ()=>{
    if(!mqttClient || !mqttClient.isConnected()) { alert("Connect to broker first."); return; }
    const { topic, payload } = getMqttFields();
    if(!topic) { alert("Topic required."); return; }
    try{
      const msg = new Paho.MQTT.Message(payload || "");
      msg.destinationName = topic;
      mqttClient.send(msg);
      setMqttStatus("Message published ‚úîÔ∏è", true);
    }catch(e){ setMqttStatus("Publish failed: "+e.message); }
  });

  async function saveEncryptedMqttSettings(){
    if(!session.unlocked) { alert("Unlock first."); return; }
    const fields = getMqttFields();
    const json = JSON.stringify({url:fields.url, clientId:fields.clientId, user:fields.user, pass:fields.pass, topic:fields.topic});
    const blob = await encryptWithKey(session.key, json);
    CONF.mqtt = blob; saveConf(CONF);
    setMqttStatus("Saved encrypted settings ‚úîÔ∏è", true);
  }
  async function loadEncryptedMqttSettings(){
    if(!CONF.mqtt) return;
    const json = await decryptWithKey(session.key, CONF.mqtt);
    const o = JSON.parse(json);
    $("#mqttUrl").value = o.url||"";
    $("#mqttClientId").value = o.clientId||"";
    $("#mqttUser").value = o.user||"";
    $("#mqttPass").value = o.pass||"";
    $("#mqttTopic").value = o.topic||"";
  }
  $("#saveMqttBtn").addEventListener("click", ()=>{ saveEncryptedMqttSettings(); });
  $("#clearMqttBtn").addEventListener("click", ()=>{
    CONF.mqtt = null; saveConf(CONF); setMqttStatus("Cleared saved settings");
  });

  // Init view if already have a vault
  (function init(){
    if(CONF.verifier){
      $("#setupBlock").classList.add("hidden"); // hide setup if vault exists
    }
    updateKeyInfo();
  })();
  </script>
</body>
</html>